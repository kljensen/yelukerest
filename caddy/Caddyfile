{
    debug
}
:80 {
    log {
    }
    # Redirect to https
    redir https://{host}{uri} permanent
}

(elmclient) {
    root * /var/elmclient
    file_server
}

(postgrest) {
    # Pass /rest/ to Postgrest docker container.
    # Use the $POSTGREST_PORT environment variable to set the port.
    route /rest/* {
        uri strip_prefix /rest
        reverse_proxy postgrest:{$POSTGREST_PORT}
    }
}

(authapp) {
    # Pass /auth/ to AuthApp docker container.
    # Use the $AUTHAPP_PORT environment variable to set the port.
    route /auth/* {
        uri strip_prefix /auth
        reverse_proxy authapp:{$AUTHAPP_PORT}
    }
    route /cas/* {
        uri strip_prefix /cas
        reverse_proxy authapp:{$AUTHAPP_PORT}
    }
}

(app) {
    import elmclient
    import postgrest
    import authapp
}

# localhost https
localhost:443, host.docker.internal:443 {
    tls internal
    import app
}

{$FQDN} {
    import app
    tls {
        dns route53 {
            access_key_id {$ACME_ACCESS_KEY_ID}
            secret_access_key {$ACME_SECRET_ACCESS_KEY}
        }
    }
}
